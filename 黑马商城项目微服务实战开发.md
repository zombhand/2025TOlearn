# 黑马商城项目微服务实战开发

# 实用的点

### 工具类

其中的BeanUtil 很好用

```xml
<dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-core</artifactId>
            <version>5.8.35</version>
</dependency>
```

### mybatisplus实用插件使用

![image-20250112174704016](C:\Users\29326\AppData\Roaming\Typora\typora-user-images\image-20250112174704016.png)

### 查询集合时判空使用

```java
CollUtil.isEmpty(list);
// 为空的话返回一个
Collections.emptyList();
```



```java
// 已知ids获取对应用户
List<User> userList = listByIds(ids);
// 1获取用户id集合
List<Long> idList = userList.lambda().map(User::getId).collect(Collectors.toList());

// 2根据用户id查询地址
List<Address> address = Db.lambdaQuery(Address.class).in(Address::getUserId, userIds).list();
// 2.1获取用户id集合
List<Long> idList = userList.stream().map(User::getId).toList();
// 2.2根据用户id查询地址
List<Address> addressList = Db.lambdaQuery(Address.class).in(Address::getUserId, idList).lsit();
// 2.3转换地址VO
List<AddressVO> addressVOS = BeanUtil.copyToList(addressList, AddressVO.class);
// 2.4用户地址集合分组处理，相同用户的放入一个集合（组）中
Map<Long, List<AddressVO>> addressMap = new HashMap<>(0);
if(CollUtil.isNotEmpty(addressList)){
    addressMap = addressMap.stream().collect(Collectors.groupingBy(AddressVO::getUserId));
}
// 3.转换VO返回
List<UserVO> userVOList = new ArrayList<>(userList.size());
for (User user : userList) {
    // 3.1 转换UserPO为 VO
    UserVO vo = BeanUtil.copyProperties(user, UserVO.class);
    userVOlist.add(vo);
    // 3.2转换地址VO
    vo.setAddressVOList(addressMap.get(user.getId()));
}
```

### 状态字段的ENUM化

使用enmu类

```java
@Getter
public enum UserStatus {
    NORMAL(1, "正常"),
    FROZEN(2, "冻结"),
    ,
    @EnumValue
    private final int value;
    private final String desc;
    
    UserStatus(int value, String desc) {
        this.value = value;
        this.desc = desc;
    }
}
```

### JSON数据处理

对JSON化的数据项单独建个类

```java
@Data
@NoArgsConstructor
@AllArgsConstructor(staticName = "of")
public class UserInfo{
    private Integer age;
    private String intro;
    private String gender;
}
```

对实体类的JSON项进行注解

```java
@Data
@TableName(value = "user", autoResultMap = true)
public class User{
    /**
    *详细信息
    */
    @TableField(typeHandler = JasksonTypeHandler.class)
    private UserInfo info;
}
```

### 通用分页实体和MP转换

通用的PageQuery以UserQuery继承为例

```java
@EqualsAndHashCode(callSuper = true)
@Data
@ApiModel(description = "用户查询条件实体")
public class UserQuery extends PageQuery{
    @ApiModelProperty("用户关键字")
    private String name;
    @ApiModelProperty("用户状态：1-正常，2-冻结")
    private Integer status;
    @ApiModelProperty("余额最小值")
    private Integer minBalance;
    @ApiModelProperty("余额最大值")
    private Integer maxBalance;
}
```

```java
@Data
@ApiModel(description = "分页查询实体")
public class PageQuery{
    
    @ApiModelProperty("页码")
    private Integer pageNo = 1;
    @ApiModelProperty("页码")
    private Integer pageSize = 5;
    @ApiModelProperty("排序字段")
    private String sortBy;
    @ApiModelProperty("是否升序")
    private Boolean isAsc = true;
    
    public <T> Page<T> toMpPage(OrederItem ... itmes) {
        // 1.分页条件
        Page<T> page = Page.of(pageNo, pageSize);
        // 2.排序条件
        if(StrUtil.isNotBlank(sortBy)){
            //不为空
            page.addOrder(new OrderItem(sortBy, isAsc));
        }else if(items != null){
            // 为空，默认排序
            page.addOrder(items);
        }
        return page;
    }
    
    private <T> Page<T> toMpPage(String defaultSortBy, Boolean defaultAsc) {
        return toMpPage(new OrderItem(defaultSortBy, defaultAsc));
    }
    public <T> Page<T> toMpPageDefaultSortByCreateTime(){
        return toMpPage(new OrderItem("create_time", false));
    }
    public <T> Page<T> toMpPageDefaultSortByUpdateTime(){
        return toMpPage(new OrderItem("update_time", false));
    }
}
```

当PO和VO属性名相同时

```java
public static <PO, VO> pageDTO<VO> of(Page<PO> p, Class<VO> clazz){ // 泛型只是占位符不能获取它的字节符，所以需要调用者传入
    PageDTO<VO> dto = new PageDTO<>();
    // 1.总条数
    dto.setTotal(p.getTotal());
    // 2.总页数
	dto.setPages(p.getPages());
    // 3.当前页数据
    List<PO> records = p.getRecords();
    if (CollUtil.isEmpty(records)) {
        dto.setList(Collections.emptyList());
        return dto;
    }
    // 4.拷贝user的VO
    dto.setList(BeanUtil.copyToList(records, clazz));
    // 5.返回
    return dto;
}
```

当PO和VO属性名不同时

```java
public static <PO, VO> pageDTO<VO> of(Page<PO> p, Class<VO> clazz){ // 泛型只是占位符不能获取它的字节符，所以需要调用者传入
    PageDTO<VO> dto = new PageDTO<>();    
    // 1.总条数   
    dto.setTotal(p.getTotal());    
    // 2.总页数    
    dto.setPages(p.getPages());    
    // 3.当前页数据 
    List<PO> records = p.getRecords();    
    if (CollUtil.isEmpty(records)) {        dto.setList(Collections.emptyList());        return dto;    }    // 4.拷贝user的VO    
    dto.setList(records.stream().map(convertor).collect(Collectors.toList()));    
    // 5.返回    
    return dto;
}
```

调用案例

```java
@Override
Public PageDTO<UserVO> queryUsersPage(UserQuery query) {
    String name = query.getName();
    Integer status = query.getStatus();
    // 1.构建分页条件
    Page<User> page = query.toMpPageDefaultSortByUpdateTime();
    // 2.分页查询
    Page<User> p = lambdaQuery()
        			.like(name != null, User::getUsername, name)
        			.eq(status != null, User::getStatus, status)
        			.page(page);
    
    // 3.封装VO结果
    return PageDTO.of(p, user -> {
        // 1.拷贝基础属性
        UserVO vo = BeanUtil.copyProperties(user, UserVO.class);
        // 2.处理特殊逻辑
        vo.setUsername(vo.getUsername().subString(0, vo.getUsername().length() - 2) + "**");
        return vo;
    });
}
```

# docker

```bash
docker run -d \
	--name mysql \
	-p 3306:3306 \
	-e TZ=Asia/Shanghai \
	-e MYSQL_ROOT_PASSWORD=123456 \
	mysql
```

- docker run: 创建并运行一个容器，-d 是让容器在后台运行
- --name mysql ：给容器起个名字，必须唯一
- -p 3306:3306 ：设置端口映射
- -e KEY=VALUE：是设置环境变量
- mysql：指定运行的镜像的名字
